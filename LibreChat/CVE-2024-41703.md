# CVE-2024-41703

## Executive Summary

LibreChat v0.7.4-rc1 and earlier has incorrect access control for message updates, allowing authenticated attackers to hijack other users' conversations.

Users of LibreChat should update to the latest version (issue fixed in v0.7.4).

CVSS v3.1 String: `AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N` (5.4)

## Description

Given a `conversationId` an authenticated attacker can hijack another user's conversation.

This can be achieved by sending crafted requests to the `/api/ask/<model>` endpoint using the target's `conversationId` in place of the attacker's own.

Additionally, after performing this attack the target's conversation will be shown in the attacker's history. From this point the attacker can interact with the target's conversation using the regular user interface, without the need for any further request manipulation. From the target's perspective any injected or modified messages will be shown as having been sent by themselves.

## Reproduction

- Obtain a `conversationId` from a target user (refer to Technical Details).
  - Optional: Obtain `messageId` if you want to alter a specific message.
- Intercept a request to Edit one of the attacker's own messages.
  - This can be done with a proxy like Burp or using dev tools.
- Change the following POST request parameters:
  - `text`: Change to any text you want (this is alteration of the target's message).
  - `conversationId`: The conversation ID grabbed in Step 1.
  - `parentMessageId`: Optional, to insert the message at a particular point in the convo (or at the very end).
  - `messageId`: Optional, can be used to edit a specific message or create a new one (i.e., a new GUID).
- Submit the modified Edit message request as per above.
- Observe that the target user's message has been changed.
- Look at the attacker's own chat history, the last chat should actually be a link to the target's conversation (ref. `conversationId`).
- When the attacker sends a message inside this chat, it will be reflected 1-for-1 in the target's chat, and vice-versa (also for LLM responses).
- This completes the hijacking of the conversation.

## Technical Details

### Source Code Fixes

Two key factors were identified that contributed to this vulnerability:

- Sensitive disclosure of identifiers in the API calls for shared chats (i.e., `conversationId`, `messageId`).
- Improper authorisation of message operations, specifically for LLM endpoints.

The maintainer contributed several fixes in the following PRs:

- [LibreChat PR #3600](https://github.com/danny-avila/LibreChat/pull/3600)
- [LibreChat PR #3588](https://github.com/danny-avila/LibreChat/pull/3588)
- [LibreChat PR #3543](https://github.com/danny-avila/LibreChat/pull/3543)
- [LibreChat PR #3363](https://github.com/danny-avila/LibreChat/pull/3363)

### Obtaining a Conversation ID

In order to obtain a `conversationId` you can abuse the 'Share' conversation functionality:

- Target shares one of their private conversations and makes the link available.
- Attacker navigates to the link and is able to extract the `conversationId` from the responses (from `/api/share/<SHARED_CONVO_ID>`), as well as the messageId for each message in that convo.
  - Note: The `<SHARED_CONVO_ID>` in the API URL is not the same as the `conversationId` which is the actual ID of the target's private conversation.

## Authors

[Deeno Burgan](https://au.linkedin.com/in/deenoburgan), [Will Robertson](https://au.linkedin.com/in/will-robertson-93a0273a), [David Craggs](https://au.linkedin.com/in/david-craggs-37851793), and [Neha Malik](https://au.linkedin.com/in/neha-malik-9b63ab12) (all of Application Security Team, REA Group).

The authors would also like to thank the LibreChat maintainer [Danny Avila](https://www.linkedin.com/in/danny-avila) for working with us to get this vulnerability resolved swiftly.

## References

- [Mitre - CVE-2024-41703](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2024-41703)
- [NVD - CVE-2024-41703](https://nvd.nist.gov/vuln/detail/CVE-2024-41703)
- [LibreChat Discussion](https://github.com/danny-avila/LibreChat/discussions/3315)
- [LibreChat PR #3600](https://github.com/danny-avila/LibreChat/pull/3600)
- [LibreChat PR #3588](https://github.com/danny-avila/LibreChat/pull/3588)
- [LibreChat PR #3543](https://github.com/danny-avila/LibreChat/pull/3543)
- [LibreChat PR #3363](https://github.com/danny-avila/LibreChat/pull/3363)
- [CWE-862: Missing Authorization](https://cwe.mitre.org/data/definitions/862.html)
