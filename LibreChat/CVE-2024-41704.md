# CVE-2024-41704

## Executive Summary

LibreChat v0.7.4-rc1 and earlier does not validate the pathnames of images, leading to directory traversal attacks and potential disclosure of unshared uploaded images.

Users of LibreChat should update to the latest version (issue fixed in v0.7.4).

CVSS v3.1 String: `AV:N/AC:H/PR:L/UI:N/S:U/C:L/I:N/A:N` (3.1)

## Description

Given a known image URL, an authenticated attacker may access another user's uploaded files, regardless of the `secureImageLinks` configuration option.

Due to an error in the authorisation check to ensure that a person should be able to view that file, the check may be bypassed. This has impacts to confidentiality of what users upload to LibreChat.

## Reproduction

- Enable secure links validation feature of LibreChat.
- Login as any user (Alice).
- In a separate browser session login as another user (Bob).
- Upload an image as Bob.
- Copy the URL of that image and navigate to it from Alice's session.
- Observe the image is not displayed.
- Modify the path of the URL to include a directory traversal sequence - i.e. `/images/<Alice ID>/../<Bob ID>/image.jpg`
- The file is visible to Alice.

Note: Popular browsers may attempt to "simplify" the URL path and remove the traversal sequence.

## Technical Details

### Source Code Fixes

- There is a validator that can be turned on at `api/server/middleware/validateImageRequest.js`.
- In summary it validates:
  - That the user has a valid refresh token (i.e., session token) that is signed correctly and not expired.
  - That the path to the image requested contains the user's ID.
- The problem is that an image URL can still contain the user's ID but still point towards another user's image.
- For example:
  - Original URL: `/images/<user_id>/filename.jpg`.
  - Attacker's URL to access another user's image: `/images/<user_id>/../<another_user_id>/filename.jpg`.

The maintainer has contributed a fix in the following PR:

- [LibreChat PR #3363](https://github.com/danny-avila/LibreChat/pull/3363)

## Authors

[Deeno Burgan](https://au.linkedin.com/in/deenoburgan), [Will Robertson](https://au.linkedin.com/in/will-robertson-93a0273a), [David Craggs](https://au.linkedin.com/in/david-craggs-37851793), and [Neha Malik](https://au.linkedin.com/in/neha-malik-9b63ab12) (all of Application Security Team, REA Group).

The authors would also like to thank the LibreChat maintainer [Danny Avila](https://www.linkedin.com/in/danny-avila) for working with us to get this vulnerability resolved swiftly.

## References

- [Mitre - CVE-2024-41704](https://cve.mitre.org/cgi-bin/cvename.cgi?name=2024-41704)
- [NVD - CVE-2024-41704](https://nvd.nist.gov/vuln/detail/CVE-2024-41704)
- [LibreChat Discussion](https://github.com/danny-avila/LibreChat/discussions/3315)
- [LibreChat PR #3363](https://github.com/danny-avila/LibreChat/pull/3363)
- [CWE-35: Path Traversal](https://cwe.mitre.org/data/definitions/35.html)
